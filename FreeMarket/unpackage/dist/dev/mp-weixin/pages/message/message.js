"use strict";const e=require("../../common/vendor.js"),a=require("../../cfg.js");if(!Array){const c=e.resolveComponent("uni-list-item"),t=e.resolveComponent("uni-list");(c+t)()}const d=()=>"../../uni_modules/uni-list/components/uni-list-item/uni-list-item.js",_=()=>"../../uni_modules/uni-list/components/uni-list/uni-list.js";Math||(d+_)();const m=e.defineComponent({__name:"message",setup(c){const t=e.ref([]),i=e.ref(!1),n=e.ref("当前没有消息"),o=e.io(`${a.cfg.server}:${a.cfg.port}`,{transports:["websocket","po"],path:"/socket",timeout:5e3});e.onLoad(()=>{getApp().globalData.login&&(i.value=!0),p()}),e.onPullDownRefresh(()=>{r(getApp().globalData.login.userid)}),e.index.$on("user",()=>{i.value=!0,o.connect(),o.emit("init",{type:"client",user:getApp().globalData.login.userid})}),e.index.$on("logout",()=>{i.value=!1,o.disconnect()});function p(){console.log("onLoad"),console.log(o),o&&getApp().globalData.login&&(console.log(o.connected),o.on("connect",()=>{console.log(o.id),o.emit("init",{type:"client",user:getApp().globalData.login.userid}),o.emit("msg"),o.on("new_msg",s=>{s.userid===getApp().globalData.login.userid&&r(s.userid)})}),o.on("init",()=>{console.log("init on client")}))}function r(s){console.log("get msg",s),e.index.request({url:`${a.cfg.server}:${a.cfg.port}${a.cfg.api.prefix}${a.cfg.api.user.prefix}${a.cfg.api.user.get_msg}`,method:"POST",data:{userid:s},success(g){console.log(g),g.statusCode===200&&(t.value=g.data.data,console.log(t.value))}})}function l(s){e.index.navigateTo({url:s})}return(s,g)=>e.e({a:i.value},i.value?{b:e.o(u=>l("/pages/msg_detail/msg_detail?type=goods")),c:e.p({clickable:"true",title:"商品消息",note:t.value.goods?t.value.goods.content:n.value,rightText:t.value.goods?new Date(t.value.goods.post_date).toLocaleString():n.value}),d:e.o(u=>l("/pages/msg_detail/msg_detail?type=post")),e:e.p({clickable:"true",title:"帖子消息",note:t.value.post?t.value.post.content:n.value,rightText:t.value.post?new Date(t.value.post.post_date).toLocaleString():n.value}),f:e.o(u=>l("/pages/msg_detail/msg_detail?type=exchange")),g:e.p({clickable:"true",title:"交易消息",note:t.value.exchange?t.value.exchange.content:n.value,rightText:t.value.exchange?new Date(t.value.exchange.post_date).toLocaleString():n.value}),h:e.o(u=>l("/pages/msg_detail/msg_detail?type=user")),i:e.p({clickable:"true",title:"账号消息",note:t.value.user?t.value.user.content:n.value,rightText:t.value.user?new Date(t.value.user.post_date).toLocaleString():n.value})}:{j:e.o(u=>l("/pages/login/login"))})}}),v=e._export_sfc(m,[["__file","F:/HBuilderProjects/FreeMarket/pages/message/message.vue"]]);wx.createPage(v);
